<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>メタデータジェネレーター</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 24px;
            width: 100%;
            max-width: 800px;
            margin-top: 20px;
        }

        .label-frame {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            position: relative;
        }

        .label-frame-title {
            position: absolute;
            top: -12px;
            left: 16px;
            background-color: #ffffff;
            padding: 0 8px;
            font-weight: 600;
            color: #4b5563;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #0000cd;
            box-shadow: 0 0 0 2px rgba(197, 73, 182, 0.248);
        }

        button {
            background-color: #0000cd;
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            border: none;
            white-space: nowrap;
        }

        button:hover {
            background-color: #0000cd;
            box-shadow: 0 2px 8px rgba(197, 73, 182, 0.248);
            color: #FFFFF0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 700px;
            position: relative;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #ffb78e;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .message-box {
            display: none;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .message-box.error {
            background-color: #f44336;
        }

        .message-box.show {
            opacity: 1;
        }

        .enchant-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            background-color: #f9fafb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .remove-enchant {
            background-color: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .tab-container {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 1px solid #d1d5db;
            margin-bottom: 16px;
        }

        .tab-link {
            background-color: transparent;
            color: #6b7280;
            border-radius: 6px 6px 0 0;
            border: 1px solid transparent;
            border-bottom: none;
            padding: 8px 12px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: -1px;
        }

        .tab-link.active {
            background-color: #ffffff;
            color: #0000cd;
            border-color: #d1d5db #d1d5db #ffffff;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .button-container>button {
            flex: 1;
            text-align: center;
        }

        #confirmTextBtn,
        #confirmItemColorBtn,
        #saveEnchantsBtn,
        #saveToolCapsBtn,
        #saveToolRanksBtn,
        #insertColorCodeBtn,
        #toggleCodeVisibilityBtn,
        #removeItemColorBtn,
        #clearEnchantsBtn,
        #resetToolCapsBtn,
        #resetToolRanksBtn {
            padding: 5px 10px;
        }

        .scrollable-content {
            overflow-y: auto;
        }

        .scrollable-content::-webkit-scrollbar {
            width: 8px;
        }

        .scrollable-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .scrollable-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="text-2xl font-bold text-center mb-6 text-gray-800">メタデータジェネレーター</h1>
        <div class="label-frame">
            <div class="label-frame-title">アイテムの情報</div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-1">
                    <label for="item-name" class="block text-sm font-medium text-gray-700 mb-1">アイテムの文字列:</label>
                    <div class="relative">
                        <input type="text" id="item-name" value="default:stone" class="w-full pr-10">
                        <button id="search-item-btn"
                            class="absolute inset-y-0 right-0 px-3 flex items-center bg-gray-200 rounded-r-md hover:bg-gray-300">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div>
                    <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">数量:</label>
                    <input type="number" id="amount" value="1" min="1" class="w-full">
                </div>
                <div>
                    <label for="item-wear" class="block text-sm font-medium text-gray-700 mb-1">消耗度 (Wear):</label>
                    <input type="number" id="item-wear" value="0" min="0" class="w-full">
                </div>
            </div>
        </div>
        <div class="label-frame">
            <div class="label-frame-title">メタデータの変更</div>
            <div class="flex flex-row flex-wrap gap-2 button-container"><button id="btn-tool-caps">ツール性能</button><button
                    id="btn-desc">説明文</button><button id="btn-short-desc">短い説明文</button><button
                    id="btn-item-color">アイテムの色</button><button id="btn-enchant">エンチャント</button><button
                    id="btn-tool-ranks">ツールランク</button></div>
        </div>
        <div class="label-frame">
            <div class="label-frame-title">生成されたコマンド:</div>
            <div class="flex items-center justify-end mb-2">
                <input type="checkbox" id="slash-toggle"
                    class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
                <label for="slash-toggle" class="ml-2 block text-sm text-gray-900">コマンドの先頭に / を付ける</label>
            </div>
            <textarea id="command-display" rows="5" class="bg-gray-100 font-mono text-sm text-gray-700 resize-y"
                readonly></textarea>
            <div class="flex justify-center mt-4"><button id="copy-command-btn">コマンドをコピー</button></div>
        </div>
        <h3 class="text-center">Author: multi_nono / Nono Contributor: dark</h3>
    </div>

    <div id="textEditorModal" class="modal">
        <div class="modal-content"><span class="close-button" onclick="closeModal('textEditorModal')">&times;</span>
            <h2 id="textEditorModalTitle" class="text-xl font-semibold mb-4 text-gray-800"></h2>
            <div class="scrollable-content mb-4">
                <div id="textEditorContentDiv" contentEditable="true"
                    class="w-full h-64 text-base border border-gray-300 rounded-md p-2 overflow-auto"
                    style="white-space: pre-wrap;"></div>
            </div>
            <div class="flex justify-between items-center pt-4">
                <div><button id="insertColorCodeBtn" class="mr-2">色を選択</button><button
                        id="toggleCodeVisibilityBtn">カラーコードを隠す</button></div><button id="confirmTextBtn">決定</button>
            </div>
        </div>
    </div>
    <div id="itemColorModal" class="modal">
        <div class="modal-content"><span class="close-button" onclick="closeModal('itemColorModal')">&times;</span>
            <h2 class="text-xl font-semibold mb-4 text-gray-800">アイテムの色</h2>
            <div class="flex flex-col items-center mb-6"><label
                    class="block text-sm font-medium text-gray-700 mb-2">選択した色:</label>
                <div id="colorDisplayLabel" class="w-24 h-12 rounded-lg border border-gray-300 shadow-inner"
                    style="background-color: #FFFFFF;"></div><input type="color" id="colorPickerInput" value="#FFFFFF"
                    class="mt-4 w-20 h-10 cursor-pointer">
            </div>
            <div class="flex justify-between items-center"><button id="removeItemColorBtn"
                    class="bg-red-500 hover:bg-red-600">色を削除</button><button id="confirmItemColorBtn">決定</button></div>
        </div>
    </div>
    <div id="enchantModal" class="modal">
        <div class="modal-content"><span class="close-button" onclick="closeModal('enchantModal')">&times;</span>
            <h2 class="text-xl font-semibold mb-4">エンチャント</h2>
            <div class="scrollable-content flex-1 pt-4">
                <div class="label-frame mb-4">
                    <div class="label-frame-title">エンチャントを追加</div>
                    <div class="mb-4">
                        <label for="enchant-type" class="block text-sm font-medium mb-1">タイプ:</label>
                        <select id="enchant-type" class="w-full"></select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="enchant-level-helper" class="block text-sm font-medium mb-1">レベル(選択):</label>
                            <select id="enchant-level-helper" class="w-full"></select>
                        </div>
                        <div>
                            <label for="enchant-level-input" class="block text-sm font-medium mb-1">レベル(入力):</label>
                            <input type="number" id="enchant-level-input" min="1" value="1" class="w-full" placeholder="カスタム値">
                        </div>
                    </div>
                    <div class="flex justify-center"><button id="addEnchantBtn">エンチャントを追加</button></div>
                </div>
                <div class="label-frame">
                    <div class="label-frame-title">現在のエンチャント</div>
                    <div id="current-enchants"></div>
                </div>
            </div>
            <div class="flex justify-between items-center mt-6"><button id="clearEnchantsBtn"
                    class="bg-red-500 hover:bg-red-600">全て削除</button><button id="saveEnchantsBtn">決定</button></div>
        </div>
    </div>
    <div id="toolCapsModal" class="modal">
        <div class="modal-content"><span class="close-button" onclick="closeModal('toolCapsModal')">&times;</span>
            <h2 class="text-xl font-semibold mb-4 text-gray-800">ツール性能の編集</h2>
            <div class="tab-container"><button class="tab-link active" data-tab="weapon">武器</button><button
                    class="tab-link" data-tab="cracky">砕き</button><button class="tab-link"
                    data-tab="choppy">伐採</button><button class="tab-link" data-tab="crumbly">整地</button><button
                    class="tab-link" data-tab="snappy">切断</button><button class="tab-link"
                    data-tab="drop_level">ドロップLV</button></div>
            <div class="scrollable-content flex-1 pt-4" id="tool-caps-panels">
                <div id="tab-panel-weapon" class="tab-panel active"></div>
                <div id="tab-panel-cracky" class="tab-panel"></div>
                <div id="tab-panel-choppy" class="tab-panel"></div>
                <div id="tab-panel-crumbly" class="tab-panel"></div>
                <div id="tab-panel-snappy" class="tab-panel"></div>
                <div id="tab-panel-drop_level" class="tab-panel"></div>
            </div>
            <div class="flex justify-between items-center mt-6"><button id="resetToolCapsBtn"
                    class="bg-red-500 hover:bg-red-600">このタブをリセット</button><button id="saveToolCapsBtn">決定</button></div>
        </div>
    </div>
    <div id="toolRanksModal" class="modal">
        <div class="modal-content"><span class="close-button" onclick="closeModal('toolRanksModal')">&times;</span>
            <h2 class="text-xl font-semibold mb-4 text-gray-800">ツールランク & Dug</h2>
            <div class="scrollable-content flex-1 pt-4">
                <div class="label-frame mb-4">
                    <div class="label-frame-title">Tool Ranks</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label for="toolranks-level"
                                class="block text-sm font-medium text-gray-700 mb-1">Level:</label><input type="number"
                                id="toolranks-level" placeholder="例: 1" class="w-full"></div>
                        <div><label for="toolranks-uses"
                                class="block text-sm font-medium text-gray-700 mb-1">Uses:</label><input type="number"
                                id="toolranks-uses" placeholder="例: 0" class="w-full"></div>
                    </div>
                </div>
                <div class="label-frame">
                    <div class="label-frame-title">Dug</div>
                    <div><label for="dug-value" class="block text-sm font-medium text-gray-700 mb-1">Dug
                            値:</label><input type="number" id="dug-value" placeholder="例: 13" class="w-full"></div>
                </div>
            </div>
            <div class="flex justify-between items-center mt-6"><button id="resetToolRanksBtn"
                    class="bg-red-500 hover:bg-red-600">リセット</button><button id="saveToolRanksBtn">決定</button></div>
        </div>
    </div>

    <div id="itemSearchModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('itemSearchModal')">&times;</span>
            <h2 class="text-xl font-semibold mb-4 text-gray-800">アイテムを検索</h2>
            <input type="text" id="item-search-box" placeholder="日本語名・IDで検索..." class="w-full mb-4">
            <div id="item-search-results" class="scrollable-content border border-gray-200 rounded-md flex-1"></div>
        </div>
    </div>

    <div id="messageBox" class="message-box"></div>

    <script>
        const allItems = [
        ];

        const DEFAULT_TOOL_CAPS_DICT = {
            damage_groups: { fleshy: 1.0 }, full_punch_interval: 0.5,
            groupcaps: {
                cracky: { maxlevel: 0, times: [null, 3.0, 2.0, 1.0], uses: 30 }, choppy: { maxlevel: 0, times: [null, 3.0, 2.0, 1.0], uses: 30 },
                crumbly: { maxlevel: 0, times: [null, 3.0, 2.0, 1.0], uses: 30 }, snappy: { maxlevel: 0, times: [null, 3.0, 2.0, 1.0], uses: 30 }
            },
            max_drop_level: 0
        };
        const ENCHANTMENT_DEFS = {
            sharpness: { name: 'Sharpness', japanese: '鋭さ', maxLevel: 5, levels: { 1: 1.25, 2: 2.5, 3: 3.75, 4: 5, 5: 6.25 } }, looting: { name: 'Looting', japanese: 'ドロップ増加', maxLevel: 3, levels: { 1: 1, 2: 2, 3: 3 } },
            fortune: { name: 'Fortune', japanese: '幸運', maxLevel: 3, levels: { 1: 1, 2: 2, 3: 3 } }, unbreaking: { name: 'Unbreaking', japanese: '耐久力', maxLevel: 3, levels: { 1: 100, 2: 200, 3: 300 } },
            efficiency: { name: 'Efficiency', japanese: '効率強化', maxLevel: 5, levels: { 1: 25, 2: 30, 3: 35, 4: 40, 5: 45 } }, silk_touch: { name: 'Silk Touch', japanese: 'シルクタッチ', maxLevel: 1, levels: { 1: 1 } },
            knockback: { name: 'Knockback', japanese: 'ノックバック', maxLevel: 2, levels: { 1: 105, 2: 190 } }, power: { name: 'Power', japanese: '射撃ダメージ増加', maxLevel: 5, levels: { 1: 50, 2: 75, 3: 100, 4: 125, 5: 150 } },
            punch: { name: 'Punch', japanese: 'パンチ', maxLevel: 2, levels: { 1: 3, 2: 6 } }, infinity: { name: 'Infinity', japanese: '無限', maxLevel: 1, levels: { 1: 1 } },
            curse_of_vanishing: { name: 'Curse of Vanishing', japanese: '消滅の呪い', maxLevel: 1, levels: { 1: 1 } }
        };
        
        function toRoman(num) {
            num = parseInt(num);
            if (isNaN(num) || num < 1) return num;
            const roman = { M: 1000, CM: 900, D: 500, CD: 400, C: 100, XC: 90, L: 50, XL: 40, X: 10, IX: 9, V: 5, IV: 4, I: 1 };
            let str = '';
            for (let i of Object.keys(roman)) {
                let q = Math.floor(num / roman[i]);
                num -= q * roman[i];
                str += i.repeat(q);
            }
            return str;
        }

        let descriptionContent = "", shortDescriptionContent = "", itemColorHex = "";
        let userToolCapabilities = {}, enchantments = {};
        let tempEnchantments = {}; // For editing in the modal
        let toolRanks = { level: "", uses: "" };
        let dugValue = "";
        let includeSlash = true;

        const $ = id => document.getElementById(id);

        function deepMerge(target, ...sources) { for (const source of sources) for (const key in source) if (source.hasOwnProperty(key)) { const sourceVal = source[key], targetVal = target[key]; if (targetVal && typeof targetVal === 'object' && !Array.isArray(targetVal) && sourceVal && typeof sourceVal === 'object' && !Array.isArray(sourceVal)) { target[key] = deepMerge({}, targetVal, sourceVal); } else { target[key] = sourceVal; } } return target; }
        function showMessageBox(message, isError = false) { const box = $('messageBox'); box.textContent = message; box.className = 'message-box show' + (isError ? ' error' : ''); setTimeout(() => box.classList.remove('show'), 3000); }

        function updateCommandDisplay() {
            let metaParts = [], enchantDescParts = [], enchantMetaParts = [], enchantLuaParts = [];
            
            Object.entries(enchantments).forEach(([type, data]) => {
                const def = ENCHANTMENT_DEFS[type];
                if (!def) return;
                const { level, value } = data;

                enchantLuaParts.push(`["${type}"]={["value"]=${value}}`);
                enchantDescParts.push(`\u001b(T@x_enchanting)${def.name}\u001bE${def.maxLevel > 1 ? ` ${toRoman(level)}` : ''}`);
                enchantMetaParts.push(`\u0003is_${type}\u0002${value}`);
            });


            const hasEnchants = !!enchantLuaParts.length;
            let enchantCaps = {};
            if (enchantments.sharpness) enchantCaps = { damage_groups: { fleshy: 5 } };
            const finalCaps = deepMerge({}, enchantCaps, userToolCapabilities);
            const hasCustomCaps = Object.keys(finalCaps).length > 0;

            if (hasCustomCaps) {
                let toolCapsMeta = `\u0003tool_capabilities\u0002${JSON.stringify(finalCaps)}`;
                if (hasEnchants) {
                    const xEnchantingData = `return {${enchantLuaParts.join(',')}}`;
                    metaParts.push(`\u0001\u0002\u0003x_enchanting\u0002${xEnchantingData}\u0003is_enchanted\u00021${enchantMetaParts.join('')}${toolCapsMeta}`);
                } else { metaParts.push(`\u0001\u0002x_enchanting\u0002${toolCapsMeta}`); }
            } else if (hasEnchants) {
                const xEnchantingData = `return {${enchantLuaParts.join(',')}}`;
                metaParts.push(`\u0001\u0002\u0003x_enchanting\u0002${xEnchantingData}\u0003is_enchanted\u00021${enchantMetaParts.join('')}`);
            }

            let finalDesc = descriptionContent;
            if (toolRanks.level !== "" && toolRanks.uses !== "") {
                const levelText = `\u001b(c@#ffdf00)\u001b(T@toolranks)Level: \u001bF${toolRanks.level}\u001bE\u001bE`;
                const usesText = `\u001b(c@#9d9d9d)\u001b(T@toolranks)Uses: \u001bF${toolRanks.uses}\u001bE\u001bE`;
                finalDesc = (finalDesc ? finalDesc + '\n' : '') + levelText + '\n' + usesText;
            }
            if (hasEnchants) {
                const enchantDesc = `\n\u001b(c@#AE81FF)\u001b(T@x_enchanting)Enchanted\u001bE\u001b(c@#ffffff)\n${enchantDescParts.join('\n')}`;
                finalDesc = (finalDesc ? finalDesc + '\n' : '') + enchantDesc;
            }

            if (finalDesc) metaParts.push(`\u0003description\u0002${finalDesc}`);
            if (shortDescriptionContent) metaParts.push(`\u0003short_description\u0002${shortDescriptionContent}`);
            if (dugValue) metaParts.push(`\u0003dug\u0002${dugValue}`);

            let core = metaParts.join(""), color = itemColorHex ? `\u001bE\u0003color\u0002${itemColorHex}\u0003` : "";
            const finalMeta = core + ((core && !color) ? "\u0003" : "") + color;
            const commandPrefix = includeSlash ? '/giveme' : 'giveme';
            const wearValue = $('item-wear').value || 0;
            $('command-display').value = `${commandPrefix} ${$('item-name').value} ${$('amount').value} ${wearValue} "${finalMeta.replace(/"/g, '\\"').replace(/\u0001/g, '\\u0001').replace(/\u0002/g, '\\u0002').replace(/\u0003/g, '\\u0003').replace(/\u001b/g, '\\u001b').replace(/\n/g, '\\n').replace(/\t/g, '\\t')}"`;
        }

        function openModal(id) { $(id).style.display = 'flex'; }
        function closeModal(id) { $(id).style.display = 'none'; }

        $('item-name').addEventListener('input', updateCommandDisplay);
        $('amount').addEventListener('input', updateCommandDisplay);
        $('item-wear').addEventListener('input', updateCommandDisplay);
        $('copy-command-btn').addEventListener('click', () => { $('command-display').select(); document.execCommand('copy') ? showMessageBox("コマンドをコピーしました") : showMessageBox("コピーに失敗しました。", true); });

        $('slash-toggle').addEventListener('change', (event) => {
            includeSlash = event.target.checked;
            updateCommandDisplay();
        });

        let currentTextEditorCallback = null;
        let showCodesInTextEditor = true;
        let isComposing = false;
        function openTextEditorModal(title, initialText, callback) { $('textEditorModalTitle').textContent = title; const editor = $('textEditorContentDiv'); editor.textContent = initialText.replace(/\\n/g, '\n'); currentTextEditorCallback = callback; showCodesInTextEditor = true; $('toggleCodeVisibilityBtn').textContent = "カラーコードを隠す"; applyRichTextFormatting(); $('textEditorModal').style.display = 'flex'; }
        function closeTextEditorModal() { $('textEditorModal').style.display = 'none'; }
        function escapeHtml(text) { const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }; return text.replace(/[&<>"']/g, function (m) { return map[m]; }); }
        function saveSelection() { const selection = window.getSelection(); if (selection.rangeCount > 0) { const range = selection.getRangeAt(0); const preCaretRange = range.cloneRange(); preCaretRange.selectNodeContents($('textEditorContentDiv')); preCaretRange.setEnd(range.endContainer, range.endOffset); return preCaretRange.toString().length; } return 0; }
        function restoreSelection(savedCaretOffset) { const selection = window.getSelection(); selection.removeAllRanges(); const range = document.createRange(); range.selectNodeContents($('textEditorContentDiv')); range.collapse(true); let nodeStack = [$('textEditorContentDiv')]; let node, charIndex = 0; let foundStart = false; while (!foundStart && (node = nodeStack.pop())) { if (node.nodeType === 3) { let nextCharIndex = charIndex + node.length; if (!foundStart && savedCaretOffset >= charIndex && savedCaretOffset <= nextCharIndex) { range.setStart(node, savedCaretOffset - charIndex); foundStart = true; } charIndex = nextCharIndex; } else { let i = node.childNodes.length; while (i--) { nodeStack.push(node.childNodes[i]); } } } range.collapse(true); selection.addRange(range); }
        function applyRichTextFormatting() { if (!$('textEditorModal') || $('textEditorModal').style.display === 'none') return; const savedCaretOffset = saveSelection(); const contentDiv = $('textEditorContentDiv'); const content = contentDiv.textContent; const colorPattern = /(\\u001b\(c@#([0-9a-fA-F]{6})\))/g; let htmlContent = ''; let lastIndex = 0; let currentColor = 'inherit'; const matches = Array.from(content.matchAll(colorPattern)); for (const match of matches) { const fullCode = match[1]; const hexColor = "#" + match[2]; const startIndex = match.index; const textSegment = content.substring(lastIndex, startIndex); if (textSegment) { htmlContent += `<span style="color: ${currentColor};">${escapeHtml(textSegment)}</span>`; } if (showCodesInTextEditor) { htmlContent += `<span style="color: black;">${escapeHtml(fullCode)}</span>`; } else { htmlContent += `<span style="font-size: 0; user-select: none;">${escapeHtml(fullCode)}</span>`; } currentColor = hexColor; lastIndex = match.index + fullCode.length; } const remainingText = content.substring(lastIndex); if (remainingText) { htmlContent += `<span style="color: ${currentColor};">${escapeHtml(remainingText)}</span>`; } contentDiv.innerHTML = htmlContent; restoreSelection(savedCaretOffset); }
        $('insertColorCodeBtn').addEventListener('click', () => { const tempColorInput = document.createElement('input'); tempColorInput.type = 'color'; tempColorInput.value = '#000000'; tempColorInput.style.position = 'absolute'; tempColorInput.style.left = '-9999px'; document.body.appendChild(tempColorInput); tempColorInput.click(); tempColorInput.addEventListener('change', () => { const colorCode = tempColorInput.value.toUpperCase(); const code = `\\u001b(c@${colorCode})`; document.execCommand('insertText', false, code); document.body.removeChild(tempColorInput); applyRichTextFormatting(); }, { once: true }); });
        $('toggleCodeVisibilityBtn').addEventListener('click', () => { showCodesInTextEditor = !showCodesInTextEditor; $('toggleCodeVisibilityBtn').textContent = showCodesInTextEditor ? "カラーコードを隠す" : "カラーコードを表示"; applyRichTextFormatting(); });
        $('confirmTextBtn').addEventListener('click', () => { const rawContent = $('textEditorContentDiv').textContent.replace(/\n/g, '\\n'); if (currentTextEditorCallback) { currentTextEditorCallback(rawContent); } closeModal('textEditorModal'); });
        const textEditorDiv = $('textEditorContentDiv');
        textEditorDiv.addEventListener('compositionstart', () => { isComposing = true; });
        textEditorDiv.addEventListener('compositionend', () => { isComposing = false; applyRichTextFormatting(); });
        textEditorDiv.addEventListener('input', () => { if (!isComposing) { applyRichTextFormatting(); } });
        $('btn-desc').addEventListener('click', () => openTextEditorModal("説明文", descriptionContent, c => { descriptionContent = c; updateCommandDisplay(); }));
        $('btn-short-desc').addEventListener('click', () => openTextEditorModal("短い説明文", shortDescriptionContent, c => { shortDescriptionContent = c; updateCommandDisplay(); }));

        function openItemColorModal() { $('colorPickerInput').value = itemColorHex || '#FFFFFF'; $('colorDisplayLabel').style.backgroundColor = itemColorHex || '#FFFFFF'; openModal('itemColorModal'); }
        $('btn-item-color').addEventListener('click', openItemColorModal);
        $('colorPickerInput').addEventListener('input', () => { $('colorDisplayLabel').style.backgroundColor = $('colorPickerInput').value; });
        $('confirmItemColorBtn').addEventListener('click', () => { itemColorHex = $('colorPickerInput').value.toUpperCase(); closeModal('itemColorModal'); updateCommandDisplay(); });
        $('removeItemColorBtn').addEventListener('click', () => { itemColorHex = ""; closeModal('itemColorModal'); updateCommandDisplay(); showMessageBox("アイテムの色を削除しました。"); });
        function populateToolCapsModal() { const defaults = DEFAULT_TOOL_CAPS_DICT; const caps = deepMerge({}, defaults, userToolCapabilities); $('tab-panel-weapon').innerHTML = `<div class="label-frame"><div class="label-frame-title">武器</div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">ダメージ:</label><input type="number" step="0.1" id="fleshy-damage" value="${caps.damage_groups.fleshy}" class="w-full"></div><div><label class="block text-sm font-medium mb-1">攻撃速度:</label><input type="number" step="0.1" id="full-punch-interval" value="${caps.full_punch_interval}" class="w-full"></div></div></div>`; $('tab-panel-drop_level').innerHTML = `<div class="label-frame"><div class="label-frame-title">最大ドロップレベル</div><label class="block text-sm font-medium mr-2">値を設定:</label><input type="number" id="max-drop-level" min="0" value="${caps.max_drop_level}" class="w-24"></div>`; const groupTranslations = { "cracky": "砕き", "choppy": "伐採", "crumbly": "整地", "snappy": "切断" }; Object.entries(groupTranslations).forEach(([group, name]) => { const data = caps.groupcaps[group]; $(`tab-panel-${group}`).innerHTML = `<div class="label-frame"><div class="label-frame-title">${name}</div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium">最大レベル:</label><input type="number" id="${group}-maxlevel" value="${data.maxlevel}" class="w-full"></div><div><label class="block text-sm font-medium">耐久値:</label><input type="number" id="${group}-uses" value="${data.uses}" class="w-full"></div></div><label class="block text-sm font-medium mt-2">時間 (lv1-3):</label><div class="flex space-x-2">${[1, 2, 3].map(i => `<input type="number" step="0.1" id="${group}-time${i}" value="${data.times[i]}" class="w-1/3">`).join('')}</div></div>`; }); }
        $('btn-tool-caps').addEventListener('click', () => { populateToolCapsModal(); openModal('toolCapsModal'); });
        $('saveToolCapsBtn').addEventListener('click', () => { const activeTab = document.querySelector('.tab-link.active').dataset.tab; const activeTabName = document.querySelector('.tab-link.active').textContent; let updates = {}; switch (activeTab) { case 'weapon': updates.damage_groups = { fleshy: parseFloat($('fleshy-damage').value) }; updates.full_punch_interval = parseFloat($('full-punch-interval').value); break; case 'drop_level': updates.max_drop_level = parseInt($('max-drop-level').value); break; default: if (!updates.groupcaps) updates.groupcaps = {}; updates.groupcaps[activeTab] = { maxlevel: parseInt($(`${activeTab}-maxlevel`).value), uses: parseInt($(`${activeTab}-uses`).value), times: [null, parseFloat($(`${activeTab}-time1`).value), parseFloat($(`${activeTab}-time2`).value), parseFloat($(`${activeTab}-time3`).value)] }; break; } userToolCapabilities = deepMerge({}, userToolCapabilities, updates); closeModal('toolCapsModal'); updateCommandDisplay(); showMessageBox(`「${activeTabName}」の性能を更新しました。`); });
        $('resetToolCapsBtn').addEventListener('click', () => { const activeTab = document.querySelector('.tab-link.active'); const tabId = activeTab.dataset.tab; const tabName = activeTab.textContent; switch (tabId) { case 'weapon': delete userToolCapabilities.damage_groups; delete userToolCapabilities.full_punch_interval; break; case 'drop_level': delete userToolCapabilities.max_drop_level; break; default: if (userToolCapabilities.groupcaps && userToolCapabilities.groupcaps[tabId]) { delete userToolCapabilities.groupcaps[tabId]; if (Object.keys(userToolCapabilities.groupcaps).length === 0) { delete userToolCapabilities.groupcaps; } } break; } updateCommandDisplay(); closeModal('toolCapsModal'); showMessageBox(`「${tabName}」の性能をリセットしました。`, false); });
        document.querySelectorAll('.tab-link').forEach(tab => tab.addEventListener('click', () => { document.querySelectorAll('.tab-link, .tab-panel').forEach(el => el.classList.remove('active')); tab.classList.add('active'); $(`tab-panel-${tab.dataset.tab}`).classList.add('active'); }));
        
        // --- Enchantment Logic Start ---
        const enchantTypeSelect = $('enchant-type');
        const enchantLevelInput = $('enchant-level-input');
        const enchantLevelHelper = $('enchant-level-helper');

        function populateEnchantTypes() { enchantTypeSelect.innerHTML = '<option value="">選択してください</option>' + Object.entries(ENCHANTMENT_DEFS).map(([id, def]) => `<option value="${id}">${def.name} (${def.japanese})</option>`).join(''); }
        
        function updateEnchantmentInputs() {
            const type = enchantTypeSelect.value;
            const def = ENCHANTMENT_DEFS[type];
            if (!def) {
                enchantLevelHelper.innerHTML = '';
                enchantLevelInput.value = 1;
                return;
            }
            enchantLevelHelper.innerHTML = Array.from({ length: def.maxLevel }, (_, i) => `<option value="${i + 1}">${toRoman(i + 1)}</option>`).join('');
            enchantLevelInput.value = 1;
        }
        
        function updateCurrentEnchantsDisplay() {
            const container = $('current-enchants');
            if (Object.keys(tempEnchantments).length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">エンチャントが設定されていません</p>';
                return;
            }
            container.innerHTML = Object.entries(tempEnchantments).map(([type, data]) => {
                const def = ENCHANTMENT_DEFS[type];
                const { level, value } = data;
                return `
                <div class="enchant-item">
                    <div class="flex-grow mr-4">
                        <div class="font-medium">${def.name} ${toRoman(level)} <span class="text-gray-500 font-normal">(${def.japanese})</span></div>
                        <div class="flex items-center mt-2">
                            <label for="enchant-val-${type}" class="text-sm mr-2 text-gray-600 whitespace-nowrap">効果値:</label>
                            <input type="number" step="any" id="enchant-val-${type}"
                                class="w-full border border-d1d5db rounded-md px-2 py-1 text-sm"
                                value="${value}">
                        </div>
                    </div>
                    <button class="remove-enchant self-center" onclick="removeEnchantment('${type}')">削除</button>
                </div>`;
            }).join('');
        }

        function removeEnchantment(type) { 
            const enchantName = ENCHANTMENT_DEFS[type].name;
            delete tempEnchantments[type]; 
            updateCurrentEnchantsDisplay(); 
            showMessageBox(`${enchantName}を削除しました。`); 
        }
        window.removeEnchantment = removeEnchantment;

        $('btn-enchant').addEventListener('click', () => {
            tempEnchantments = JSON.parse(JSON.stringify(enchantments));
            updateCurrentEnchantsDisplay();
            openModal('enchantModal');
        });
        
        enchantTypeSelect.addEventListener('change', updateEnchantmentInputs);
        
        enchantLevelHelper.addEventListener('change', () => {
            enchantLevelInput.value = enchantLevelHelper.value;
        });

        $('addEnchantBtn').addEventListener('click', () => {
            const type = enchantTypeSelect.value;
            const level = parseInt(enchantLevelInput.value);
            if (!type) {
                showMessageBox('タイプを選択してください。', true);
                return;
            }
            if (isNaN(level) || level < 1) {
                showMessageBox('有効なレベルを入力してください。', true);
                return;
            }
            const def = ENCHANTMENT_DEFS[type];
            let value;
            if (def.levels[level]) {
                value = def.levels[level];
            } else {
                const maxLevelInDefs = Math.max(...Object.keys(def.levels).map(k => parseInt(k)));
                value = def.levels[maxLevelInDefs] || 0;
            }
            tempEnchantments[type] = { level: level, value: value };
            updateCurrentEnchantsDisplay();
            showMessageBox(`${def.name} をレベル ${toRoman(level)} で追加しました。`);
        });
        
        $('clearEnchantsBtn').addEventListener('click', () => { 
            tempEnchantments = {}; 
            updateCurrentEnchantsDisplay(); 
            showMessageBox('全エンチャントを削除しました。'); 
        });

        $('saveEnchantsBtn').addEventListener('click', () => {
            const container = $('current-enchants');
            container.querySelectorAll('.enchant-item input[type="number"]').forEach(input => {
                const type = input.id.substring(12); // "enchant-val-".length
                const parsedValue = parseFloat(input.value);
                if (tempEnchantments[type] && !isNaN(parsedValue)) {
                    tempEnchantments[type].value = parsedValue;
                }
            });

            enchantments = JSON.parse(JSON.stringify(tempEnchantments));
            updateCommandDisplay();
            closeModal('enchantModal');
            showMessageBox('エンチャント情報を保存しました。');
        });
        // --- Enchantment Logic End ---

        $('btn-tool-ranks').addEventListener('click', () => { $('toolranks-level').value = toolRanks.level; $('toolranks-uses').value = toolRanks.uses; $('dug-value').value = dugValue; openModal('toolRanksModal'); });
        $('saveToolRanksBtn').addEventListener('click', () => { toolRanks.level = $('toolranks-level').value; toolRanks.uses = $('toolranks-uses').value; dugValue = $('dug-value').value; if (toolRanks.level === "" || toolRanks.uses === "") { toolRanks.level = ""; toolRanks.uses = ""; } updateCommandDisplay(); closeModal('toolRanksModal'); showMessageBox('ツールランクとDugの情報を更新しました。'); });
        $('resetToolRanksBtn').addEventListener('click', () => { toolRanks.level = ""; toolRanks.uses = ""; dugValue = ""; updateCommandDisplay(); closeModal('toolRanksModal'); showMessageBox('ツールランクとDugの情報をリセットしました。'); });

        function openItemSearchModal() {
            $('item-search-box').value = '';
            searchItemsAndDisplay();
            openModal('itemSearchModal');
            $('item-search-box').focus();
        }

        function searchItemsAndDisplay() {
            const query = $('item-search-box').value.toLowerCase().trim();
            const resultsContainer = $('item-search-results');
            resultsContainer.innerHTML = '';

            const filteredItems = query === ''
                ? allItems
                : allItems.filter(item =>
                    item.name.toLowerCase().includes(query) ||
                    item.id.toLowerCase().includes(query)
                );

            if (filteredItems.length === 0) {
                resultsContainer.innerHTML = `<div class="p-2 text-gray-500 text-center">一致するアイテムが見つかりません。</div>`;
                return;
            }

            filteredItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'p-2 hover:bg-gray-100 cursor-pointer text-sm';
                itemDiv.textContent = `${item.name} (${item.id})`;
                itemDiv.onclick = () => {
                    $('item-name').value = item.id;
                    updateCommandDisplay();
                    closeModal('itemSearchModal');
                };
                resultsContainer.appendChild(itemDiv);
            });
        }

        $('search-item-btn').addEventListener('click', openItemSearchModal);
        $('item-search-box').addEventListener('input', searchItemsAndDisplay);

        window.onload = () => {
            populateEnchantTypes();
            updateEnchantmentInputs();
            updateCommandDisplay();
        };
    </script>
</body>

</html>